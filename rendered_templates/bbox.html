<html>

<head>
    <script src='//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js'></script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/json3/3.3.2/json3.min.js'></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/vue/2.0.5/vue.js" charset="utf-8"></script>
    <!-- <script src="jquery.min.js" charset="utf-8"></script> -->
    <!-- <script src="json3.min.js" charset="utf-8"></script> -->
    <!-- <script src="vue.js" charset="utf-8"></script> -->
    <!-- <link rel="stylesheet" href="skeleton.min.css"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css">
    <style media="screen">
        .container {
            max-width: 1024px;
        }

        .anno-rect {
            stroke: rgba(0, 255, 0, .8);
            fill: rgba(0, 0, 0, 0);
            stroke-width: 2;
        }

        .anno-rect:hover {
            fill: rgba(0, 255, 0, .2);
        }

        .anno-rect.selected {
            fill: rgba(0, 255, 0, .2);
        }

        g image {
            visibility: hidden;
        }

        g:hover image {
            visibility: visible;
        }

        input[type="submit"]:disabled {
            background: #dddddd;
            border: 1px solid #dddddd;
            color: black;
            cursor: not-allowed;
        }

    </style>
</head>

<body>
    <br>

    <div id="app" class='container'>
        <h3>draw boxes around the matching items</h3>
        <div class="row">
            <div class="two columns">
                <h6>find the item below</h6>
                <center><img style="max-width:100px; max-height:100px; border: 1px solid #ddd" v-bind:src="prototypeImageUrl" alt="" /></center>
            </div>
            <div class="ten columns">
                <h6>in this image <b>&#8681;</b> and draw boxes around the matching items</h6>
                <annotated-image v-bind:url="mainImageUrl" ></annotated-image>
                <br>
                <br>
                <form id='results-form' method='post' action='dummy' accept-charset="utf-8" enctype="application/x-www-form-urlencoded" class='text-center'>
                    <input type='hidden' value='' name='assignmentId' id='assignmentId' />
                    <input type='hidden' value='hello' name='output' id='output' />
                    <input type='submit' class='button-primary' id='submit-btn' v-on:click="onSubmitClick" v-bind:value="submitButtonMessage()" v-bind:disabled="mturkPreview"/>
                </form>

            </div>
        </div>
        <br>
        <br>
    </div>

    <script type='text/json' id='input'>
    
</script>


<script>
    var simpleamt = (function() {

        // Copied from http://james.padolsey.com/javascript/bujs-1-getparameterbyname/
        function getUrlParam(name) {
            var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
            return match ? decodeURIComponent(match[1].replace(/\+/g, ' ')) : null;
        }

        function getInput(default_input) {
            if (typeof(default_input) === 'undefined') default_input = null;
            try {
                return JSON.parse($('#input').html());
            } catch (e) {
                return default_input;
            }
        }

        function setOutput(output) {
            $('#output').val(JSON.stringify(output));

        }

        function isPreview() {
            var assignment_id = getUrlParam('assignmentId');
            if (assignment_id === null)
                return true;
            return assignment_id == 'ASSIGNMENT_ID_NOT_AVAILABLE';
        }

        function setupSubmit() {
            var submit_to = getUrlParam('turkSubmitTo');
            var action = submit_to + '/mturk/externalSubmit';
            var assignment_id = getUrlParam('assignmentId');

            $('#results-form').attr('action', action);
            $('#assignmentId').val(assignment_id);
            console.log("assignmentId="+assignment_id);
            console.log("action="+action);
        }

        return {
            getInput: getInput,
            setOutput: setOutput,
            isPreview: isPreview,
            setupSubmit: setupSubmit,
            getUrlParam: getUrlParam
        }

    })();
</script>

    <script>

        // Will return w, nw, n, ne, e, se, s, sw for the eight borders,
        // n for inside, or "" when current location not in `dirs`.
        function whichborder(mousexy, elem_xywh) {
            var x = elem_xywh[0];
            var y = elem_xywh[1];
            var w = elem_xywh[2];
            var h = elem_xywh[3];
            var border = "";

            if (mousexy[1] <= y + 6)
                border += 'n';
            else if (mousexy[1] >= y + h - 6)
                border += 's';

            if (mousexy[0] <= x + 6)
                border += 'w';
            else if (mousexy[0] >= x + w - 6)
                border += 'e';

            if (mousexy[0] > x + w + 0 ||
                mousexy[0] < x - 0 ||
                mousexy[1] < y - 0 ||
                mousexy[1] > y + h + 0)
                border = "O";
            else if (border == "")
                border = "M";

            return border;
        }

        Vue.component('annotated-image', {
            props: {
                "url": String,
                "annotations": {
                    default: function() {
                        return []
                    }
                },
                "showlabels": Boolean
            },

            data: function() {
                return {
                    anno_counter: 0,
                    image_height: 0,
                    image_width: 0,
                    mouse_x: null,
                    mouse_y: null,
                    mouse_down_x: null,
                    mouse_down_y: null,
                    mouse_down_target: null,
                    mouse_over_target: null,
                    action: null,
                    cursor: "crosshair"
                };
            },

            methods: {

                getAnnotationIndexFromId: function(aid) {
                    for (var i = 0; i < this.annotations.length; i++) {
                        if (this.annotations[i].i === aid) {
                            return i;
                        }
                    }
                    return -1;
                },

                getHoveredAnnotationRegion: function(xy) {
                    var region = "O";
                    var i = this.annotations.length - 1;
                    for (; i >= 0; i--) {
                        var a = this.annotations[i];
                        var elem_xywh = [a.x * this.image_width,
                            a.y * this.image_height,
                            a.width * this.image_width,
                            a.height * this.image_height
                        ];
                        var region = whichborder(mousexy, elem_xywh);
                        if (region !== "O")
                            break;
                    }
                    return {
                        "region": region,
                        "i": i
                    };
                },

                updateAnnotations: function() {
                    bus.annotations = this.annotations;
                },

                handleDeleteAnnotation: function(target, event) {
                    this.annotations = this.annotations.filter(function(a, i) {
                        return i != target.index;
                    });
                },

                addAnnotation: function() {
                    var bbox = {
                        x: this.mouse_x / this.image_width,
                        y: this.mouse_y / this.image_height,
                        width: 10.0 / this.image_width,
                        height: 10.0 / this.image_height,
                        i: this.anno_counter++
                    };
                    this.annotations.push(bbox);
                    this.mouse_down_target = this.annotations.length - 1;
                    bus.annotations = this.annotations;
                },

                handleMouseMove: function(event) {
                    var dx = (event.offsetX - this.mouse_x) / this.image_width;
                    var dy = (event.offsetY - this.mouse_y) / this.image_height;
                    var i = this.mouse_down_target;

                    if (this.action === "move") {
                        this.annotations[i].x += dx;
                        this.annotations[i].y += dy;
                    } else if (this.action) {
                        var resize_action = this.action.split("_")[0];
                        if (resize_action.indexOf("e") != -1)
                            this.annotations[i].width = Math.max(0, this.annotations[i].width + dx);
                        if (resize_action.indexOf("s") != -1)
                            this.annotations[i].height = Math.max(0, this.annotations[i].height + dy);
                        if (resize_action.indexOf("n") != -1) {
                            this.annotations[i].height = Math.max(0, this.annotations[i].height - dy);
                            this.annotations[i].y = Math.max(0, this.annotations[i].y + dy);
                        }
                        if (resize_action.indexOf("w") != -1) {
                            this.annotations[i].width = Math.max(0, this.annotations[i].width - dx);
                            this.annotations[i].x = Math.max(0, this.annotations[i].x + dx);
                        }
                    }

                    // udpate annotations
                    this.updateAnnotations();


                    // hover events
                    console.log(event.target.tagName);
                    var mousexy = [event.offsetX, event.offsetY];
                    for (var i = this.annotations.length - 1; i >= 0; i--) {
                        var a = this.annotations[i];
                        var elem_xywh = [a.x * this.image_width,
                            a.y * this.image_height,
                            a.width * this.image_width,
                            a.height * this.image_height
                        ];
                        var region = whichborder(mousexy, elem_xywh);
                        if (region !== "O")
                            break;
                    }

                    if (region === "M") {
                        this.cursor = "move";
                    } else if (region === "O") {
                        this.cursor = "crosshair";
                    } else {
                        this.cursor = region + "-resize";
                    }

                    this.mouse_x = event.offsetX;
                    this.mouse_y = event.offsetY;


                },

                handleMouseDown: function(event) {
                    this.mouse_down_x = event.offsetX;
                    this.mouse_down_y = event.offsetY;
                    this.mouse_down = true;
                    console.log(event.target.targetName);
                    if (event.target.tagName == "svg") {
                        this.addAnnotation();
                        this.action = "se_resize";
                    } else if (event.target.tagName == "rect") {
                        var aid = parseInt(event.target.getAttribute("i"));
                        var i = this.getAnnotationIndexFromId(aid);
                        this.mouse_down_target = i;
                        console.log(i);
                        var a = this.annotations[i];
                        var elem_xywh = [a.x * this.image_width, a.y * this.image_height,
                            a.width * this.image_width, a.height * this.image_height
                        ];
                        var mousexy = [this.mouse_down_x, this.mouse_down_y];
                        var region = whichborder(mousexy, elem_xywh);

                        if (region === "M")
                            this.action = "move";
                        else {
                            this.action = region + "_resize";
                        }
                    }
                },

                handleMouseUp: function(event) {
                    this.mouse_down_x = null;
                    this.mouse_down_y = null;
                    this.mouse_down_target = null;
                    this.action = null;
                    console.log(event.target.tagName);
                    if (event.target.tagName === "image") {
                        var aid = parseInt(event.target.getAttribute("i"));
                        var idx = this.getAnnotationIndexFromId(aid);
                        this.annotations.splice(idx, 1);
                        this.cursor = "crosshair";

                    }
                },

            },

            computed: {
                bboxes: function() {
                    return this.annotations.map(function(a) {
                        var copy = Object.assign({}, a);
                        copy.x *= this.image_width;
                        copy.y *= this.image_height;
                        copy.width *= this.image_width;
                        copy.height *= this.image_height;
                        return copy;
                    }.bind(this));
                }
            },

            mounted: function(el) {
                this.$el.getElementsByTagName("img")[0].onload = function(event) {
                    this.image_height = event.target.clientHeight;
                    this.image_width = event.target.clientWidth;
                }.bind(this);
            },

            render: function(h) {
                var annos = this.bboxes.map(function(b, i) {
                    return h("g", {}, [
                        h("rect", {
                            attrs: {
                                x: b.x,
                                y: b.y,
                                width: b.width,
                                height: b.height,
                                i: b.i
                            },
                            "class": {
                                "anno-rect": true,
                                "selected": this.mouse_down_target == b.i
                            }
                        }),
                        h("image", {
                            attrs: {
                                "width": 16,
                                "height": 16,
                                "xlink:href": "https://cdn1.iconfinder.com/data/icons/ui-navigation-1/152/close-128.png",
                                "x": b.x + b.width - 8,
                                "y": b.y - 8,
                                "i": b.i
                            },
                            style: {
                                "cursor": "pointer",
                                // "visibility": this.mouse_down_target == b.i ? "visible" : "hidden"
                            },
                        }),

                    ]);
                }.bind(this));

                return h("div", {
                    style: {
                        "position": "relative",
                        "cursor": this.cursor
                    },
                    on: {
                        mousedown: this.handleMouseDown,
                        mouseup: this.handleMouseUp,
                        mousemove: this.handleMouseMove,
                    }
                }, [
                    h("img", {
                        style: {
                            "position": "relative",
                            "max-width": "100%",
                            "max-height": "800px",
                            "top": 0,
                            "left": 0
                        },
                        attrs: {
                            "src": this.url
                        }
                    }),
                    h("svg", {
                            style: {
                                "position": "absolute",
                                "width": this.image_width,
                                "height": this.image_height,
                                "top": 0,
                                "left": 0
                            }
                        },
                        annos),
                ]);
            }
        });

        var bus = new Vue({
            data: {
                annotations: []
            }
        });
        var app = new Vue({
            el: "#app",
            methods: {
                submitButtonMessage: function() {
                    if (this.mturkPreview) {
                        return "You must accept the HIT to submit results";
                    } else if (bus.annotations.length == 0) {
                        return "Submit: no matching logos";
                    } else {
                        return "Submit: " + bus.annotations.length + " bounding boxes";
                    }
                },
                onSubmitClick: function(event) {
                    var output = {
                        question: {
                            templates: [this.prototypeImageUrl],
                            photo: this.mainImageUrl
                        },
                        answer: {
                            annotations: bus.annotations,
                        }
                    };
                    var outputStr = JSON.stringify(output);
                    simpleamt.setOutput(outputStr);
                    console.log(JSON.stringify(output, null, 4));
                }
            },
            mounted: function() {
                console.log("mturk in preview mode = " + simpleamt.isPreview());
                if (!simpleamt.isPreview()) {
                    console.log("setting up form submit");

                    simpleamt.setupSubmit();

                    // setup input
                    var input = simpleamt.getInput();
                    this.prototypeImageUrl = input["prototype"];
                    this.mainImageUrl = input.image;
                    this.mturkPreview = false;
                }
            },

            data: {
                mainImageUrl: "http://media.ussportscamps.com/assets/camps/soccer/slideshow/nike-soccer-camps-ucsc-18.jpg",
                prototypeImageUrl: "http://ecx.images-amazon.com/images/I/21Pd3+4L8HL._AC_UL160_SR160,160_.jpg",
                mturkPreview: true,
            },
        });

    </script>
</body>

</html>